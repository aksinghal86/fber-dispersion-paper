---
title: "Supplemental Materials"
format: html
editor: visual
---

```{r include=F}
knitr::opts_chunk$set(echo=F)

library(tidyverse)
concentrations <- read_rds(here::here('data/processed/concentrations.rds'))
```

## Determination of plume direction

Plume direction was estimated using total particulate concentrations. However, as shown in Figure 1 of the *Methods* section of the manuscript, a sample was not collected at each distance and degree combination. For example, no samples were collected at NE, NW, SW, and SE directions at 8 ft.

First, a complete map of particulate concentrations was generated by inferring concentrations at missing locations by taking the mean of the concentrations from the two adjacent locations at given distance in either direction. 

```{r fill missing values, message=F}
mean_fill <- function (x) { 
  idx <- which(is.na(x))
  x[idx] <- (x[idx-1] + x[idx+1])/2
  x
}
particles <- concentrations %>% 
  filter(!is.na(radians)) %>% 
  group_by(distance = distance_ft, degrees, radians, direction) %>% 
  summarize(conc = mean(all_particles_cc)) %>% 
  ungroup() %>% 
  complete(distance, nesting(degrees, radians, direction)) %>% 
  mutate(conc = mean_fill(conc))
```


Then, each particle concentration vector was decomposed into its $\vec{x}$ and $\vec{y}$ components using the following equations:

$$ \vec{y} = c_i \times sin (\theta_{i}) $$

$$ \vec{x} = c_i \times cos (\theta_{i}) $$

where $c_i$ represents the particulate concentration (in particles/cc); and $\theta_i$ is the vector angle in radians.

```{r decompose vectors, echo=F}
x <- particles$conc * cos(particles$radians)
y <- particles$conc * sin(particles$radians)
```

Mean of each component vector ($\bar{y}$, $\bar{x}$) was calculated and input into the following equation for calculating the resulting angle of particle dispersion (in radians):

$$ \bar{\theta} = arctan2 \left( \frac{\bar{y}}{\bar{x}} \right) $$

Angle in degrees is equivalent to: 

$$ \theta^\circ = \theta_{radian} \times (360/2\pi) $$

```{r calculate average vector and angle}
x_bar <- mean(x, na.rm=T)
y_bar <- mean(y, na.rm=T)
z_bar <- sqrt(x_bar^2 + y_bar^2)

theta_bar <- atan2(y_bar, x_bar)
theta_bar_deg <- theta_bar * 180/pi


cat(paste(c('x_bar:', 'y_bar:', 'z_bar:', 'theta_bar (rad):', 'theta_bar (deg):'),
          round(c(x_bar, y_bar, z_bar, theta_bar, theta_bar_deg), 2)), 
    sep = ', ')
```

Figure below shows mean particulate concentration (in log scale) for a given direction (solid line), where length of vector is proportional to particulate concentration. Dashed line indicates the inferred angle of plume direction. This was estimated to be approximately $5^\circ$, which is consistent with the east facing direction of the cuts.  

```{r, message=F, warning=F, fig.height=6}
particles %>% 
  group_by(radians, degrees) %>% 
  summarize(avg_conc = mean(conc), 
            group = "individual") %>% 
  # filter(!is.na(radians)) %>% 
  ungroup() %>% 
  add_row(radians = theta_bar, degrees = theta_bar_deg, avg_conc = z_bar, group = 'average') %>%
  
  ggplot(aes(x = degrees, y = particles_cc, size = group, linetype = group)) + 
  coord_polar(theta = 'x', start = -1.57, direction = -1) + 
  geom_segment(aes(y=0, xend=degrees, yend=avg_conc), arrow=arrow(length=unit(0.2,"cm"))) +
  scale_x_continuous(limits = c(0, 360), breaks = seq(0, 360, by = 45)) +
  scale_y_log10() +
  labs(y = 'Particulate concentration (particles/cc), log scale', 
       title = 'Determination of plume direction using\nmean particulate concentrations', 
       subtitle = '(solid line = estimated plume direction)') + 
  scale_linetype_manual(values = c('dashed', 'solid')) +
  # scale_color_grey() + 
  scale_size_manual(values = c(1., 0.8)) + 
  theme_bw() + 
  theme(legend.position = 'none', 
        text = element_text(size = 12), 
        axis.title.x = element_blank()) 
```

